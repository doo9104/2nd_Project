<!DOCTYPE html>
<html 	xmlns:th="http://www.thymeleaf.org"
         xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
         xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
         layout:decorator="layout/default">

<div layout:fragment="content">

    <section id="portfolio" class="portfolio">
        <div class="container" style="margin-top: 30px;">
            <form>
                <small>글 번호</small>
                <input class="form-control" type="text" id="id" name="id" th:value="${post.id}" readonly/>
                <small>제목</small>
                <input class="form-control" type="text" id="title" name="title" th:value="${post.title}" readonly/>
                <small>내용</small>
                <textarea class="form-control" id="content" name="content" readonly th:text="${post.content}"></textarea>
                <small>작성자</small>
                <input class="form-control" type="text" id="writer" name="writer" th:value="${post.writer}" readonly/>
            </form>

            <div sec:authorize="isAuthenticated()" th:if="${#authentication.getName() == post.writer}">
                <a class="btn btn-primary" type="button"  th:href="@{'/dog/modify/' + ${post.id}}" >수정</a>
                <button class="btn btn-primary" type="button" id="btn-delete">삭제</button>
                <a class="btn btn-primary" type="button"  href="/dog" >목록</a>
            </div>
            <div th:unless="${#authentication.getName() == post.writer}">
                <a class="btn btn-primary" type="button"  href="/dog" >목록</a>
            </div>

        </div>


        <!-- 뒤에 패딩 85px 고민해볼것-->
        <div class="container" style="margin-top: 20px;margin-bottom: 0px;padding-bottom: 10px;padding-top: 5px;border-top-left-radius:20px;border-top-right-radius:20px;border: 1px solid #1b212d;padding-right: 85px;padding-left: 85px;">
            <div>
                <div style="margin-bottom: 5px;margin-top: 5px;margin-left: 5px;margin-right: 5px;"><small>Your Comment</small></div>
                <div ><textarea id='cContent' class="border rounded" style="width: 100%;margin-left: 5px;margin-right: 5px;" maxlength="500" rows="4" placeholder="Comment" required></textarea>
                </div>

                <div class="d-xs-flex d-sm-flex d-md-flex d-lg-flex d-xl-flex justify-content-sm-end justify-content-md-end justify-content-lg-end justify-content-xl-end">
                <!--<button class="btn btn-primary" type="button" style="margin-left: 5px;margin-right: 5px;">Button</button>-->
                <button id="btn-add" class="learn-more">등록</button>
                </div>


            </div>
        </div>
        <div class="container" id="comments" style="background-color: #1b212d;padding-top: 15px;padding-bottom: 15px;padding-right: 25px;padding-left: 55px;width: 1140px;margin-top: 0;border-bottom-right-radius:20px;border-bottom-left-radius:20px;">

            <!--<div class="comment" style="margin-top: 20px;margin-right: 30px;margin-bottom: 20px;margin-left: 30px;padding: 10px;"><img class="rounded float-left commentPic" src="/assets/img/anonymAvatar.png" style="max-width: 45px;max-height: 45px;margin-right: 15px;">
                <div>
                    <div class="d-flex align-items-center align-items-sm-center align-items-md-center align-items-lg-center align-items-xl-center">
                        <h3 class="d-block d-sm-block d-md-block d-lg-block d-xl-block commentAuthor" style="color: #ffffff;font-size: 1.17em;margin-bottom: 0;">admin 관리자</h3>
                        <span class="publishDate" style="color: #787878;margin-left: 15px;font-size: 11px;">Right now<br></span>
                    </div>
                    <span class="commentContent" style="color: #ffffff;margin-top: 5px;margin-bottom: 5px;">텍스트입니다 텍스트입니다</span>
                </div>
            </div>
            <hr>-->


        <!---->
        </div>
          </section>

    <div class="d-lg-none scroll-to-top position-fixed rounded"><a
            class="d-block js-scroll-trigger text-center text-white rounded" href="#page-top"><i
            class="fa fa-chevron-up"></i></a></div>
</div>



<th:block layout:fragment="script">
<script th:inline="javascript" th:src="@{'/js/app/comments.js'}"></script>

    <!-- 기본 -->
    <script th:inline="javascript">
        // 댓글 리스트 가져오기 sec:authorize="isAuthenticated()"
        (function getAllReplies(){
            //load replies
            commentsmanager.getAll([[${post.id}]], printList);
        })();

        // 댓글 리스트 화면 출력처리
        function printList(list){
            var str = "";
            var commentObj;
            var principalName;
            var commentWriter;
            for(var i = 0; i < list.length; i++){
                commentObj = list[i];

                str +=
                    "<div class=\"comment\" style=\"margin-top: 20px;margin-right: 30px;margin-bottom: 20px;margin-left: 30px;padding: 10px;\">" +
                    "<img class=\"rounded float-left commentPic\" src=\"/assets/img/anonymAvatar.png\" style=\"max-width: 45px;max-height: 45px;margin-right: 15px;\">" +
                    "<div class=\"float-left\" style=\"width: 80%;\">" +
                    "<div class=\"d-flex align-items-center align-items-sm-center align-items-md-center align-items-lg-center align-items-xl-center\">" +
                    "<h3 class=\"d-block d-sm-block d-md-block d-lg-block d-xl-block commentAuthor\" style=\"color: #ffffff;font-size: 1.17em;margin-bottom: 0;\">"+commentObj.writer+"</h3>"+
                    "<span class=\"publishDate\" style=\"color: #787878;margin-left: 15px;font-size: 11px;\">"+formatDate(commentObj.modifiedDate)+"<br></span>"+
                    "</div>"+
                    "<span data-commentno="+commentObj.id+ " class=\"commentContent\" style=\"color: #ffffff;margin-top: 5px;margin-bottom: 5px;\">"+commentObj.content+"</span>"+
                    "</div>" +
                    "<a id=\"btn-commentlike\" href=\"/\" style=\"color: rgb(255,255,255);font-size: 25px;\"><i data-toggle=\"tooltip\" title=\"추천\" class=\"fas fa-thumbs-up\"></i></a>&nbsp;&nbsp;&nbsp;";


                /* 삭제 */
                /*[# sec:authorize="isAuthenticated()"]*/
                principalName = [[${#authentication.principal.nickname}]];
                commentWriter = commentObj.writer;
                if(principalName == commentWriter) {
                    str +=
                        "<a id=\"btn-commentmodify\" data-commentno="+commentObj.id+ " href=\"#\" style=\"color: rgb(255,255,255);font-size: 25px;\"><i data-toggle=\"tooltip\" title=\"수정\" class=\"fas fa-pencil-alt\"></i></a>&nbsp;&nbsp;&nbsp;" +
                        "<a id=\"btn-commentremove\" data-commentno=" + commentObj.id + " href=\"#\" style=\"color: rgb(255,255,255);font-size: 25px;\"><i data-toggle=\"tooltip\" title=\"삭제\" class=\"fas fa-trash-alt\"></i></a>&nbsp;&nbsp;&nbsp;";
                }
                /*[/]*/



                     str += "</div><hr>";
            }
            $("#comments").html(str);
        }

        // 날짜 형식 YYYY-MM-DD
        function formatDate(timeValue){
            var date = new Date(timeValue);
            return  date.getFullYear()
                + "-" + (date.getMonth()+1 >= 10?date.getMonth()+1 : '0'+ (date.getMonth()+1)  )
                + "-" + (date.getDate() >= 10?date.getDate() : '0'+ (date.getDate()) )
                + " / " + date.getHours() + ":" + date.getMinutes()
        }
    </script>

    <!-- 회원일때-->
    <script sec:authorize="isAuthenticated()" th:inline="javascript">
        var bid = [[${post.id}]];
        var passcid;
        var commentMode = true; // 글쓰기 : true , 수정 : false

        // 댓글 추가후 입력란 비우고 댓글 불러오기
        function afterAll(list){
            printList(list);
            $('#cContent').val('');
        };

        //var writer = [[${#authentication.getName()}]];
        //var test = [[${#authentication.principal.nickname}]];

        // 댓글 등록/수정
        $('#btn-add').on('click',function () {

            if(commentMode == true) { // 글쓰기 모드일때
                var writer = [[${#authentication.principal.nickname}]];
                var content = $('#cContent').val();
                var obj = {content:content, writer: writer, id:bid};

                commentsmanager.add(obj, function(list){
                    bootbox.alert("댓글을 등록하였습니다.");
                    afterAll(list);
                })
            } else if(commentMode == false){
                var content = $('#cContent').val();

                var obj = {content:content,bid:bid,id:passcid};

                commentsmanager.update(obj, function(list){
                    bootbox.alert("댓글을 수정하였습니다.");
                    afterAll(list);
                });
                commentMode = true;
            }
        });

        // 댓글 수정
        $(document).on("click","#btn-commentmodify",function(e){
            e.preventDefault();
            cid = $(this).data('commentno');
            passcid = cid;

            var string = $('span[data-commentno="' + cid + '"]').text();
            $('#cContent').val(string);
            $('#cContent').focus();

            commentMode = false;
        });

        // 댓글 삭제
        $(document).on("click","#btn-commentremove",function(e){
            e.preventDefault();
            var cid = $(this).data('commentno');
            var obj = {bid:bid, cid:cid};
            bootbox.confirm({
                title: "삭제 확인",
                message: "댓글을 정말 삭제하시겠습니까?",
                buttons: {
                    cancel: { label: '<i class="fa fa-times"></i> 취소', className: 'btn-success' },
                    confirm: { label: '<i class="fa fa-check"></i> 삭제', className: 'btn-danger' }
                },
                callback: function (result) {
                    if(result) { // == true
                        bootbox.alert("댓글을 삭제하였습니다.");
                        commentsmanager.remove(obj, function(list){
                            afterAll(list);
                        });
                    }
                }
            });














        });





    </script>

    <!-- 익명사용자일때-->
   <script sec:authorize="isAnonymous()" th:inline="javascript">
       // 댓글 등록
       $('#btn-add').on('click',function () {
           bootbox.confirm({
               title: "로그인",
               message: "로그인 후에 작성할 수 있습니다. 로그인 하시겠습니까?",
               buttons: {
                   cancel: { label: '<i class="fa fa-times"></i> 취소' },
                   confirm: { label: '<i class="fa fa-check"></i> 로그인' }
               },
               callback: function (result) {
                    if(result == true) {
                        window.location.href = '/login';
                    }
               }
           });
       });

       $(document).on("click","#btn-commentlike",function(e){
           e.preventDefault();
           bootbox.alert("로그인한 유저만 추천할 수 있습니다.");
       });


    </script>





</th:block>





</html>

